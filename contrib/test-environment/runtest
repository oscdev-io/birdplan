#!/bin/bash

set -eux

pacman -Q bird
pacman -Q exabgp
pacman -Q stayrtr

cd /root/birdplan || :
echo "Excuting in '$(pwd)'..."

ARGS=("$@")

# Work out what args we're passing
default_args="1"
if [ ${#ARGS[@]} -gt 0 ]; then
    default_args=""
fi
# If we have a single argument, we can still use default args
if [ ${#ARGS[@]} -eq 1 ]; then
    # As long as its not --write-expected
    if [ "${ARGS[0]}" == "--write-expected" ]; then
        default_args="1"
    fi
fi
# Finally check if we are actually using our default args
if [ -n "$default_args" ]; then
    cpus=$(nproc)
    jobcount=$((cpus / 2))
    ARGS+=(--numprocesses="$jobcount" --dist=loadfile)
fi

nice -n 20 tox run -e runtest --recreate -- "${ARGS[@]}"
