#!/bin/bash

set -eux

pacman -Q bird
pacman -Q exabgp

cd /root/birdplan || :
echo "Excuting in '$(pwd)'..."

ARGS=("$@")
if [ ${#ARGS[@]} -eq 0 ] || [ ${#ARGS[@]} -eq 1 ] && [ "${ARGS[0]}" == "--write-expected" ]; then
    cpus=$(nproc)
    jobcount=$((cpus / 2))
    ARGS+=(--numprocesses="$jobcount" --dist=loadfile)
fi

echo "RUNNING: tox -- ${ARGS[*]}"
nice -n 20 tox -- "${ARGS[@]}"
nice -n 20 tox -e cov-html
